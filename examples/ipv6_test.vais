# IPv6 networking test example
# Demonstrates IPv6 socket support in std/net.vais
#
# Note: This example shows IPv6 API usage.
# For actual execution, ensure IPv6 is enabled on your system.

# Test IPv6 address validation
F test_ipv6_validation() -> i64 {
    println("=== Testing IPv6 Address Validation ===")

    # Valid IPv6 addresses
    valid1 := is_valid_ip6("::1")
    valid2 := is_valid_ip6("fe80::1")
    valid3 := is_valid_ip6("2001:db8::8a2e:370:7334")
    valid4 := is_valid_ip6("::")

    print("::1 is valid: ")
    println_i64(valid1)

    print("fe80::1 is valid: ")
    println_i64(valid2)

    print("2001:db8::8a2e:370:7334 is valid: ")
    println_i64(valid3)

    print(":: is valid: ")
    println_i64(valid4)

    # Invalid address
    invalid := is_valid_ip6("not-an-ipv6")
    print("not-an-ipv6 is valid: ")
    println_i64(invalid)

    println("")
    0
}

# Test IPv6 TCP listener
F test_ipv6_tcp_listener() -> i64 {
    println("=== Testing IPv6 TCP Listener ===")

    # Create IPv6 TCP listener on port 9090
    listener := TcpListener.bind6(9090)

    I listener.is_valid() {
        print("Successfully created IPv6 TCP listener on port: ")
        println_i64(listener.get_port())
        listener.close()
        println("Listener closed")
    } E {
        println("Failed to create IPv6 TCP listener")
    }

    println("")
    0
}

# Test IPv6 TCP client (connection attempt)
F test_ipv6_tcp_client() -> i64 {
    println("=== Testing IPv6 TCP Client ===")

    # Try to connect to localhost (::1) on port 8080
    # This will fail unless a server is running, which is expected
    stream := TcpStream.connect6("::1", 8080)

    I stream.is_valid() {
        println("Successfully connected to [::1]:8080")
        stream.close()
    } E {
        println("Failed to connect to [::1]:8080 (expected - no server running)")
    }

    println("")
    0
}

# Test IPv6 UDP socket
F test_ipv6_udp_socket() -> i64 {
    println("=== Testing IPv6 UDP Socket ===")

    # Create and bind IPv6 UDP socket on port 9091
    socket := UdpSocket.bind6(9091)

    I socket.is_valid() {
        print("Successfully created IPv6 UDP socket on port: ")
        println_i64(socket.get_port())

        # Create unbound IPv6 UDP socket for sending
        sender := UdpSocket.new6()

        I sender.is_valid() {
            println("Created unbound IPv6 UDP socket")

            # Send test message to localhost
            msg := "Hello IPv6!"
            bytes_sent := sender.send_to6(msg, 12, "::1", 9091)

            I bytes_sent > 0 {
                print("Sent ")
                print_i64(bytes_sent)
                println(" bytes via IPv6 UDP")

                # Try to receive the message
                buffer := malloc(256)
                src_ip := malloc(46)   # IPv6 addresses can be up to 45 chars + null
                src_port := malloc(8)

                bytes_recv := socket.recv_from6(buffer, 256, src_ip, src_port)

                I bytes_recv > 0 {
                    print("Received ")
                    print_i64(bytes_recv)
                    print(" bytes from [")
                    print(src_ip)
                    print("]:")
                    println_i64(load_i64(src_port))

                    print("Message: ")
                    println(buffer)
                }

                free(buffer)
                free(src_ip)
                free(src_port)
            }

            sender.close()
        }

        socket.close()
        println("Socket closed")
    } E {
        println("Failed to create IPv6 UDP socket")
    }

    println("")
    0
}

# Test C-style IPv6 API
F test_ipv6_c_style_api() -> i64 {
    println("=== Testing IPv6 C-style API ===")

    # TCP listener
    listener_fd := tcp_listen6(9092)
    I listener_fd >= 0 {
        print("Created IPv6 TCP listener (fd: ")
        print_i64(listener_fd)
        println(")")
        tcp_close_listener(listener_fd)
    } E {
        println("Failed to create IPv6 TCP listener")
    }

    # UDP socket
    udp_fd := udp_bind6(9093)
    I udp_fd >= 0 {
        print("Created IPv6 UDP socket (fd: ")
        print_i64(udp_fd)
        println(")")
        udp_close(udp_fd)
    } E {
        println("Failed to create IPv6 UDP socket")
    }

    println("")
    0
}

# Test sockaddr_in6 structure creation
F test_sockaddr_in6() -> i64 {
    println("=== Testing sockaddr_in6 Structure ===")

    # Create sockaddr_in6 for specific address
    addr1 := make_sockaddr_in6("::1", 8080)
    I addr1 != 0 {
        println("Successfully created sockaddr_in6 for [::1]:8080")

        # Verify family
        family := load_i16(addr1)
        print("Family: ")
        print_i64(family)
        print(" (AF_INET6: ")
        print_i64(AF_INET6)
        println(")")

        free(addr1)
    } E {
        println("Failed to create sockaddr_in6")
    }

    # Create sockaddr_in6 for any address (::)
    addr2 := make_sockaddr_any6(9000)
    I addr2 != 0 {
        println("Successfully created sockaddr_in6 for [::]:9000")
        free(addr2)
    } E {
        println("Failed to create sockaddr_in6 for any address")
    }

    println("")
    0
}

# Main function
F main() -> i64 {
    println("========================================")
    println("IPv6 Network Socket Test")
    println("========================================")
    println("")

    test_ipv6_validation()
    test_sockaddr_in6()
    test_ipv6_tcp_listener()
    test_ipv6_tcp_client()
    test_ipv6_udp_socket()
    test_ipv6_c_style_api()

    println("========================================")
    println("IPv6 Test Complete")
    println("========================================")

    0
}
