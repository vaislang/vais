# AOEL Example 08: Validate Email
# 이메일 형식 검증

UNIT FUNCTION examples.validate_email V1.0.0

META
  DOMAIN examples.validation
  DETERMINISM true
  PURE true
ENDMETA

INPUT
  email : STRING    [LEN >= 5, LEN <= 254]
ENDINPUT

OUTPUT
  valid   : BOOL
  reason  : OPTIONAL<STRING>
ENDOUTPUT

INTENT
  GOAL VALIDATE: input.email -> output.valid
  PRIORITY CORRECTNESS
ENDINTENT

CONSTRAINT
  REQUIRE LEN(input.email) >= 5
  INVARIANT NOT output.valid IMPLIES output.reason != VOID
ENDCONSTRAINT

FLOW
  NODE check_length : VALIDATE (condition=LEN(input.email) >= 5 AND LEN(input.email) <= 254)
  NODE check_at     : VALIDATE (condition=CONTAINS(input.email, "@"))
  NODE check_format : VALIDATE (pattern=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/)
  NODE build_ok     : TRANSFORM (valid=true, reason=VOID)
  NODE build_err    : TRANSFORM (valid=false)

  EDGE INPUT.email       -> check_length
  EDGE check_length.ok   -> check_at
  EDGE check_length.err  -> build_err
  EDGE build_err         -> OUTPUT.valid WHEN check_length.err
  EDGE build_err         -> OUTPUT.reason (value="Invalid length") WHEN check_length.err

  EDGE check_at.ok       -> check_format
  EDGE check_at.err      -> build_err
  EDGE build_err         -> OUTPUT.valid WHEN check_at.err
  EDGE build_err         -> OUTPUT.reason (value="Missing @ symbol") WHEN check_at.err

  EDGE check_format.ok   -> build_ok
  EDGE check_format.err  -> build_err
  EDGE build_err         -> OUTPUT.valid WHEN check_format.err
  EDGE build_err         -> OUTPUT.reason (value="Invalid format") WHEN check_format.err

  EDGE build_ok          -> OUTPUT.valid
ENDFLOW

EXECUTION
  PARALLEL false
  TARGET ANY
  MEMORY STACK_ONLY
ENDEXECUTION

VERIFY
  ASSERT output.valid == true OR output.reason != VOID
  TEST @tests.validation.email_valid
  TEST @tests.validation.email_no_at
  TEST @tests.validation.email_too_short
  TEST @tests.validation.email_invalid_domain
ENDVERIFY

END
