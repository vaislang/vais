# Vais Package System Design

**Version:** 1.0.0
**Date:** 2026-01-12

---

## Overview

패키지 시스템은 Vais 생태계의 **핵심 인프라**입니다.

```
개발자가 패키지를 쉽게:
1. 만들고 (create)
2. 공유하고 (publish)
3. 사용할 수 있어야 (install)

생태계가 성장합니다.
```

---

## Design Principles

| 원칙 | 설명 | 참고 |
|------|------|------|
| **Simple** | 진입장벽 낮춤 | npm처럼 쉽게 |
| **Secure** | 악성 패키지 방지 | 검증 시스템 |
| **Fast** | 빠른 설치/빌드 | Cargo/pnpm 참고 |
| **Reproducible** | 동일한 빌드 보장 | Lock 파일 |
| **Decentralized** | 미러/프라이빗 레지스트리 | npm/maven 참고 |

---

## Package Structure

### Basic Layout

```
my-package/
├── vais.toml           # 패키지 매니페스트 (필수)
├── README.md           # 문서 (권장)
├── LICENSE             # 라이선스 (권장)
├── src/
│   ├── lib.vais        # 라이브러리 진입점
│   └── main.vais       # 실행 파일 진입점 (옵션)
├── tests/
│   └── test_*.vais     # 테스트 파일
├── examples/
│   └── *.vais          # 예제
├── benches/
│   └── *.vais          # 벤치마크
└── vais.lock           # 의존성 Lock (자동 생성)
```

### Manifest (vais.toml)

```toml
[package]
name = "http-client"
version = "1.2.0"
edition = "2026"
description = "A simple HTTP client for Vais"
authors = ["Your Name <you@example.com>"]
license = "MIT"
repository = "https://github.com/you/http-client"
homepage = "https://http-client.vais.dev"
documentation = "https://docs.vais.dev/http-client"
keywords = ["http", "client", "networking"]
categories = ["network", "web"]
readme = "README.md"

# 최소 Vais 버전
vais = ">=1.0.0"

[dependencies]
std = "1.0"
url = "1.2"
json = { version = "2.0", optional = true }
tls = { version = "1.0", default-features = false }

[dev-dependencies]
test = "1.0"
mock = "0.5"

[build-dependencies]
codegen = "0.1"

[features]
default = ["json"]
full = ["json", "http2", "websocket"]
http2 = ["dep:http2-impl"]
websocket = ["dep:ws-impl"]

# FFI 의존성
[ffi.python]
packages = ["requests"]

[ffi.rust]
crates = ["reqwest"]

# 빌드 설정
[build]
target = "lib"           # lib, bin, both
optimize = "release"     # debug, release

# 문서 빌드 설정
[docs]
all-features = true
rustdoc-args = ["--cfg", "docsrs"]

# 프로필 설정
[profile.dev]
opt-level = 0
debug = true

[profile.release]
opt-level = 3
lto = true
```

### Lock File (vais.lock)

```toml
# 자동 생성 - 수동 편집 금지
# This file is automatically generated - do not edit

[[package]]
name = "http-client"
version = "1.2.0"
dependencies = [
    "std 1.0.5",
    "url 1.2.3",
    "json 2.0.1",
]

[[package]]
name = "std"
version = "1.0.5"
checksum = "sha256:abc123..."

[[package]]
name = "url"
version = "1.2.3"
checksum = "sha256:def456..."
dependencies = [
    "std 1.0.5",
]

[[package]]
name = "json"
version = "2.0.1"
checksum = "sha256:ghi789..."
dependencies = [
    "std 1.0.5",
]
```

---

## CLI Commands

### Project Management

```bash
# 새 프로젝트 생성
vais new my-project                    # 바이너리 프로젝트
vais new my-lib --lib                  # 라이브러리 프로젝트
vais new my-project --template web     # 템플릿 사용

# 기존 디렉토리에 초기화
vais init
vais init --lib
```

### Dependency Management

```bash
# 의존성 추가
vais add http                          # 최신 버전
vais add http@1.2.0                    # 특정 버전
vais add http --features full          # 기능 선택
vais add http --optional               # 선택적 의존성
vais add http --dev                    # 개발 의존성

# 의존성 제거
vais remove http

# 의존성 업데이트
vais update                            # 모두 업데이트
vais update http                       # 특정 패키지
vais update --patch                    # 패치만 업데이트

# 의존성 확인
vais deps                              # 의존성 트리
vais deps --outdated                   # 업데이트 가능한 것
vais deps --duplicates                 # 중복 확인
```

### Build & Run

```bash
# 빌드
vais build                             # 개발 빌드
vais build --release                   # 릴리즈 빌드
vais build --target wasm32             # 크로스 컴파일

# 실행
vais run                               # 메인 실행
vais run --example hello               # 예제 실행

# 테스트
vais test                              # 모든 테스트
vais test test_http                    # 특정 테스트
vais test --coverage                   # 커버리지

# 벤치마크
vais bench

# 린트
vais lint
vais lint --fix

# 포맷
vais fmt
vais fmt --check
```

### Publishing

```bash
# 로그인
vais login

# 퍼블리시 전 체크
vais publish --dry-run

# 퍼블리시
vais publish

# 버전 올리기
vais version patch                     # 1.0.0 → 1.0.1
vais version minor                     # 1.0.0 → 1.1.0
vais version major                     # 1.0.0 → 2.0.0

# Yank (문제있는 버전 숨김)
vais yank http-client@1.2.0
vais yank http-client@1.2.0 --undo
```

### Search & Info

```bash
# 패키지 검색
vais search http
vais search "http client" --category network

# 패키지 정보
vais info http-client
vais info http-client --versions

# 문서 열기
vais doc http-client
vais doc http-client --open            # 브라우저에서 열기
```

---

## Package Registry

### Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     registry.vais.dev                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Web UI     │  │   REST API   │  │  CLI Client  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                           │                                  │
│  ┌────────────────────────┴─────────────────────────┐      │
│  │                   API Gateway                     │      │
│  └────────────────────────┬─────────────────────────┘      │
│                           │                                  │
│  ┌──────────┬──────────┬──────────┬──────────┐             │
│  │ Package  │ Version  │  Search  │   Auth   │             │
│  │ Service  │ Service  │ Service  │ Service  │             │
│  └──────────┴──────────┴──────────┴──────────┘             │
│                           │                                  │
│  ┌──────────────────────────────────────────────┐          │
│  │              Storage (S3/GCS)                 │          │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐      │          │
│  │  │Packages │  │  Index  │  │  Docs   │      │          │
│  │  └─────────┘  └─────────┘  └─────────┘      │          │
│  └──────────────────────────────────────────────┘          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### API Endpoints

```
# 패키지
GET    /api/v1/packages                    # 목록
GET    /api/v1/packages/:name              # 상세
GET    /api/v1/packages/:name/versions     # 버전 목록
GET    /api/v1/packages/:name/:version     # 특정 버전
PUT    /api/v1/packages/:name              # 퍼블리시
DELETE /api/v1/packages/:name/:version     # Yank

# 다운로드
GET    /api/v1/download/:name/:version     # 패키지 다운로드

# 검색
GET    /api/v1/search?q=:query             # 검색

# 인증
POST   /api/v1/auth/login                  # 로그인
POST   /api/v1/auth/token                  # API 토큰 발급
DELETE /api/v1/auth/token/:id              # 토큰 삭제

# 사용자
GET    /api/v1/users/:username             # 프로필
GET    /api/v1/users/:username/packages    # 사용자 패키지
```

### Security Features

```yaml
# 패키지 검증
- Checksum verification (SHA256)
- Signature verification (optional, GPG/signify)
- Malware scanning
- License detection
- Dependency audit

# 계정 보안
- 2FA required for publishing
- API token scoping
- Rate limiting
- Audit logs

# 네임스페이스
- Reserved names (std, core, ffi)
- Organization namespaces (@org/package)
- Verified publishers badge
```

---

## Version Resolution

### SemVer

```toml
# 정확한 버전
http = "1.2.3"

# 캐럿 (^) - 기본, 마이너 업데이트 허용
http = "^1.2.3"    # >=1.2.3, <2.0.0
http = "^0.2.3"    # >=0.2.3, <0.3.0 (0.x는 마이너가 breaking)

# 틸드 (~) - 패치만 허용
http = "~1.2.3"    # >=1.2.3, <1.3.0

# 범위
http = ">=1.0, <2.0"
http = ">1.0, <=2.0"

# 와일드카드
http = "1.*"       # >=1.0.0, <2.0.0
http = "1.2.*"     # >=1.2.0, <1.3.0
```

### Resolution Algorithm

```
1. 모든 의존성 요구사항 수집
2. 호환 가능한 버전 범위 계산
3. 각 패키지에서 가장 높은 호환 버전 선택
4. 충돌 시 backtracking
5. Lock 파일 생성
```

### Conflict Resolution

```bash
# 충돌 확인
vais deps --conflicts

# 수동 해결
[dependencies]
http = "1.0"

[overrides]
# 특정 의존성의 transitive 의존성 강제
url = "2.0"  # http가 url 1.x를 요구해도 2.0 사용
```

---

## Workspaces

### Monorepo Support

```
my-workspace/
├── vais.toml           # 워크스페이스 설정
├── packages/
│   ├── core/
│   │   ├── vais.toml
│   │   └── src/
│   ├── cli/
│   │   ├── vais.toml
│   │   └── src/
│   └── web/
│       ├── vais.toml
│       └── src/
└── shared/
    └── utils/
        ├── vais.toml
        └── src/
```

### Workspace Config

```toml
# 루트 vais.toml
[workspace]
members = [
    "packages/*",
    "shared/*",
]
exclude = [
    "packages/experimental",
]

# 공유 의존성 버전
[workspace.dependencies]
std = "1.0"
json = "2.0"

# 공유 설정
[workspace.package]
edition = "2026"
license = "MIT"
repository = "https://github.com/org/workspace"
```

### Member Config

```toml
# packages/cli/vais.toml
[package]
name = "my-cli"
version = "1.0.0"

# 워크스페이스 설정 상속
edition.workspace = true
license.workspace = true

[dependencies]
# 워크스페이스 버전 사용
std.workspace = true
json.workspace = true

# 워크스페이스 내 패키지 참조
core = { path = "../core" }
utils = { path = "../../shared/utils" }
```

---

## Private Registry

### Self-Hosted

```yaml
# docker-compose.yml
version: "3"
services:
  registry:
    image: vais/registry:latest
    ports:
      - "3000:3000"
    environment:
      - STORAGE_TYPE=s3
      - S3_BUCKET=my-vais-packages
      - DATABASE_URL=postgres://...
    volumes:
      - ./config:/etc/vais-registry
```

### Config

```toml
# ~/.vais/config.toml

[registries]
# 기본 레지스트리
default = "https://registry.vais.dev"

# 프라이빗 레지스트리
[registries.private]
url = "https://vais.mycompany.com"
token = "env:PRIVATE_REGISTRY_TOKEN"

# 미러
[registries.mirror]
url = "https://mirror.vais.cn"
fallback = "default"
```

### Usage

```toml
# vais.toml
[dependencies]
# 공개 레지스트리 (기본)
http = "1.0"

# 프라이빗 레지스트리
internal-lib = { version = "1.0", registry = "private" }
```

---

## Caching

### Local Cache

```
~/.vais/
├── cache/
│   ├── packages/           # 다운로드된 패키지
│   │   └── http-1.0.0/
│   ├── git/                # Git 의존성
│   └── registry/           # 레지스트리 인덱스
├── bin/                    # 설치된 바이너리
└── config.toml
```

### Cache Commands

```bash
# 캐시 정보
vais cache info

# 캐시 정리
vais cache clean
vais cache clean --all

# 오프라인 모드
vais build --offline
```

---

## Publishing Checklist

### Before Publishing

```bash
# 1. 버전 확인
vais version

# 2. 테스트 통과
vais test

# 3. 린트 통과
vais lint

# 4. 문서 빌드
vais doc

# 5. dry-run
vais publish --dry-run
```

### Package Quality

```yaml
# 레지스트리 품질 점수 기준
quality_score:
  - has_readme: 10
  - has_license: 10
  - has_tests: 15
  - has_docs: 15
  - has_examples: 10
  - ci_passing: 15
  - no_vulnerabilities: 15
  - maintained: 10  # 최근 6개월 내 업데이트
```

---

## Integration

### CI/CD

```yaml
# GitHub Actions
name: Vais CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: vais/setup-vais@v1
        with:
          version: "1.0"
      - run: vais test
      - run: vais lint

  publish:
    needs: test
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: vais/setup-vais@v1
      - run: vais publish
        env:
          VAIS_TOKEN: ${{ secrets.VAIS_TOKEN }}
```

### IDE Integration

```json
// VSCode settings.json
{
    "vais.packageManager": "vais",
    "vais.formatOnSave": true,
    "vais.lintOnSave": true
}
```

---

## Migration Guide

### From npm

```bash
# package.json → vais.toml 변환
vais migrate npm
```

### From Cargo

```bash
# Cargo.toml → vais.toml 변환
vais migrate cargo
```

### From pip

```bash
# requirements.txt → vais.toml 변환
vais migrate pip
```

---

## Summary

패키지 시스템 설계 핵심:

| 요소 | 설명 |
|------|------|
| **vais.toml** | Cargo.toml 스타일 매니페스트 |
| **vais.lock** | 재현 가능한 빌드 보장 |
| **CLI** | npm + Cargo의 좋은 점 조합 |
| **Registry** | 중앙 + 프라이빗 지원 |
| **Workspace** | 모노레포 지원 |
| **Security** | 서명, 스캔, 감사 |

**쉬운 패키지 시스템 = 활발한 생태계**
