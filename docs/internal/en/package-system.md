# Vais Package System Design

**Version:** 1.0.0
**Date:** 2026-01-12

---

## Overview

The package system is the **core infrastructure** of the Vais ecosystem.

```
For the ecosystem to grow, developers must be able to easily:
1. Create packages
2. Share packages (publish)
3. Use packages (install)
```

---

## Design Principles

| Principle | Description | Reference |
|-----------|-------------|-----------|
| **Simple** | Low entry barrier | Easy like npm |
| **Secure** | Prevent malicious packages | Verification system |
| **Fast** | Fast install/build | Cargo/pnpm inspired |
| **Reproducible** | Guarantee identical builds | Lock file |
| **Decentralized** | Mirror/private registry | npm/maven inspired |

---

## Package Structure

### Basic Layout

```
my-package/
├── vais.toml           # Package manifest (required)
├── README.md           # Documentation (recommended)
├── LICENSE             # License (recommended)
├── src/
│   ├── lib.vais        # Library entry point
│   └── main.vais       # Binary entry point (optional)
├── tests/
│   └── test_*.vais     # Test files
├── examples/
│   └── *.vais          # Examples
├── benches/
│   └── *.vais          # Benchmarks
└── vais.lock           # Dependency lock (auto-generated)
```

### Manifest (vais.toml)

```toml
[package]
name = "http-client"
version = "1.2.0"
edition = "2026"
description = "A simple HTTP client for Vais"
authors = ["Your Name <you@example.com>"]
license = "MIT"
repository = "https://github.com/you/http-client"
homepage = "https://http-client.vais.dev"
documentation = "https://docs.vais.dev/http-client"
keywords = ["http", "client", "networking"]
categories = ["network", "web"]
readme = "README.md"

# Minimum Vais version
vais = ">=1.0.0"

[dependencies]
std = "1.0"
url = "1.2"
json = { version = "2.0", optional = true }
tls = { version = "1.0", default-features = false }

[dev-dependencies]
test = "1.0"
mock = "0.5"

[build-dependencies]
codegen = "0.1"

[features]
default = ["json"]
full = ["json", "http2", "websocket"]
http2 = ["dep:http2-impl"]
websocket = ["dep:ws-impl"]

# FFI dependencies
[ffi.python]
packages = ["requests"]

[ffi.rust]
crates = ["reqwest"]

# Build settings
[build]
target = "lib"           # lib, bin, both
optimize = "release"     # debug, release

# Documentation build settings
[docs]
all-features = true
rustdoc-args = ["--cfg", "docsrs"]

# Profile settings
[profile.dev]
opt-level = 0
debug = true

[profile.release]
opt-level = 3
lto = true
```

### Lock File (vais.lock)

```toml
# Auto-generated - do not edit manually
# This file is automatically generated - do not edit

[[package]]
name = "http-client"
version = "1.2.0"
dependencies = [
    "std 1.0.5",
    "url 1.2.3",
    "json 2.0.1",
]

[[package]]
name = "std"
version = "1.0.5"
checksum = "sha256:abc123..."

[[package]]
name = "url"
version = "1.2.3"
checksum = "sha256:def456..."
dependencies = [
    "std 1.0.5",
]

[[package]]
name = "json"
version = "2.0.1"
checksum = "sha256:ghi789..."
dependencies = [
    "std 1.0.5",
]
```

---

## CLI Commands

### Project Management

```bash
# Create new project
vais new my-project                    # Binary project
vais new my-lib --lib                  # Library project
vais new my-project --template web     # Use template

# Initialize in existing directory
vais init
vais init --lib
```

### Dependency Management

```bash
# Add dependency
vais add http                          # Latest version
vais add http@1.2.0                    # Specific version
vais add http --features full          # Select features
vais add http --optional               # Optional dependency
vais add http --dev                    # Dev dependency

# Remove dependency
vais remove http

# Update dependencies
vais update                            # Update all
vais update http                       # Specific package
vais update --patch                    # Patch updates only

# Check dependencies
vais deps                              # Dependency tree
vais deps --outdated                   # Outdated packages
vais deps --duplicates                 # Check duplicates
```

### Build & Run

```bash
# Build
vais build                             # Dev build
vais build --release                   # Release build
vais build --target wasm32             # Cross compile

# Run
vais run                               # Run main
vais run --example hello               # Run example

# Test
vais test                              # All tests
vais test test_http                    # Specific test
vais test --coverage                   # Coverage

# Benchmark
vais bench

# Lint
vais lint
vais lint --fix

# Format
vais fmt
vais fmt --check
```

### Publishing

```bash
# Login
vais login

# Pre-publish check
vais publish --dry-run

# Publish
vais publish

# Bump version
vais version patch                     # 1.0.0 → 1.0.1
vais version minor                     # 1.0.0 → 1.1.0
vais version major                     # 1.0.0 → 2.0.0

# Yank (hide problematic version)
vais yank http-client@1.2.0
vais yank http-client@1.2.0 --undo
```

### Search & Info

```bash
# Search packages
vais search http
vais search "http client" --category network

# Package info
vais info http-client
vais info http-client --versions

# Open documentation
vais doc http-client
vais doc http-client --open            # Open in browser
```

---

## Package Registry

### Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     registry.vais.dev                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Web UI     │  │   REST API   │  │  CLI Client  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                           │                                  │
│  ┌────────────────────────┴─────────────────────────┐      │
│  │                   API Gateway                     │      │
│  └────────────────────────┬─────────────────────────┘      │
│                           │                                  │
│  ┌──────────┬──────────┬──────────┬──────────┐             │
│  │ Package  │ Version  │  Search  │   Auth   │             │
│  │ Service  │ Service  │ Service  │ Service  │             │
│  └──────────┴──────────┴──────────┴──────────┘             │
│                           │                                  │
│  ┌──────────────────────────────────────────────┐          │
│  │              Storage (S3/GCS)                 │          │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐      │          │
│  │  │Packages │  │  Index  │  │  Docs   │      │          │
│  │  └─────────┘  └─────────┘  └─────────┘      │          │
│  └──────────────────────────────────────────────┘          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### API Endpoints

```
# Packages
GET    /api/v1/packages                    # List
GET    /api/v1/packages/:name              # Details
GET    /api/v1/packages/:name/versions     # Version list
GET    /api/v1/packages/:name/:version     # Specific version
PUT    /api/v1/packages/:name              # Publish
DELETE /api/v1/packages/:name/:version     # Yank

# Download
GET    /api/v1/download/:name/:version     # Package download

# Search
GET    /api/v1/search?q=:query             # Search

# Authentication
POST   /api/v1/auth/login                  # Login
POST   /api/v1/auth/token                  # Issue API token
DELETE /api/v1/auth/token/:id              # Delete token

# Users
GET    /api/v1/users/:username             # Profile
GET    /api/v1/users/:username/packages    # User's packages
```

### Security Features

```yaml
# Package verification
- Checksum verification (SHA256)
- Signature verification (optional, GPG/signify)
- Malware scanning
- License detection
- Dependency audit

# Account security
- 2FA required for publishing
- API token scoping
- Rate limiting
- Audit logs

# Namespace
- Reserved names (std, core, ffi)
- Organization namespaces (@org/package)
- Verified publishers badge
```

---

## Version Resolution

### SemVer

```toml
# Exact version
http = "1.2.3"

# Caret (^) - default, allows minor updates
http = "^1.2.3"    # >=1.2.3, <2.0.0
http = "^0.2.3"    # >=0.2.3, <0.3.0 (0.x minor is breaking)

# Tilde (~) - patch only
http = "~1.2.3"    # >=1.2.3, <1.3.0

# Range
http = ">=1.0, <2.0"
http = ">1.0, <=2.0"

# Wildcard
http = "1.*"       # >=1.0.0, <2.0.0
http = "1.2.*"     # >=1.2.0, <1.3.0
```

### Resolution Algorithm

```
1. Collect all dependency requirements
2. Calculate compatible version ranges
3. Select highest compatible version for each package
4. Backtrack on conflicts
5. Generate lock file
```

### Conflict Resolution

```bash
# Check conflicts
vais deps --conflicts

# Manual resolution
[dependencies]
http = "1.0"

[overrides]
# Force specific transitive dependency
url = "2.0"  # Use 2.0 even if http requires url 1.x
```

---

## Workspaces

### Monorepo Support

```
my-workspace/
├── vais.toml           # Workspace config
├── packages/
│   ├── core/
│   │   ├── vais.toml
│   │   └── src/
│   ├── cli/
│   │   ├── vais.toml
│   │   └── src/
│   └── web/
│       ├── vais.toml
│       └── src/
└── shared/
    └── utils/
        ├── vais.toml
        └── src/
```

### Workspace Config

```toml
# Root vais.toml
[workspace]
members = [
    "packages/*",
    "shared/*",
]
exclude = [
    "packages/experimental",
]

# Shared dependency versions
[workspace.dependencies]
std = "1.0"
json = "2.0"

# Shared settings
[workspace.package]
edition = "2026"
license = "MIT"
repository = "https://github.com/org/workspace"
```

### Member Config

```toml
# packages/cli/vais.toml
[package]
name = "my-cli"
version = "1.0.0"

# Inherit workspace settings
edition.workspace = true
license.workspace = true

[dependencies]
# Use workspace versions
std.workspace = true
json.workspace = true

# Reference packages within workspace
core = { path = "../core" }
utils = { path = "../../shared/utils" }
```

---

## Private Registry

### Self-Hosted

```yaml
# docker-compose.yml
version: "3"
services:
  registry:
    image: vais/registry:latest
    ports:
      - "3000:3000"
    environment:
      - STORAGE_TYPE=s3
      - S3_BUCKET=my-vais-packages
      - DATABASE_URL=postgres://...
    volumes:
      - ./config:/etc/vais-registry
```

### Config

```toml
# ~/.vais/config.toml

[registries]
# Default registry
default = "https://registry.vais.dev"

# Private registry
[registries.private]
url = "https://vais.mycompany.com"
token = "env:PRIVATE_REGISTRY_TOKEN"

# Mirror
[registries.mirror]
url = "https://mirror.vais.cn"
fallback = "default"
```

### Usage

```toml
# vais.toml
[dependencies]
# Public registry (default)
http = "1.0"

# Private registry
internal-lib = { version = "1.0", registry = "private" }
```

---

## Caching

### Local Cache

```
~/.vais/
├── cache/
│   ├── packages/           # Downloaded packages
│   │   └── http-1.0.0/
│   ├── git/                # Git dependencies
│   └── registry/           # Registry index
├── bin/                    # Installed binaries
└── config.toml
```

### Cache Commands

```bash
# Cache info
vais cache info

# Clean cache
vais cache clean
vais cache clean --all

# Offline mode
vais build --offline
```

---

## Publishing Checklist

### Before Publishing

```bash
# 1. Check version
vais version

# 2. Pass tests
vais test

# 3. Pass lint
vais lint

# 4. Build docs
vais doc

# 5. Dry-run
vais publish --dry-run
```

### Package Quality

```yaml
# Registry quality score criteria
quality_score:
  - has_readme: 10
  - has_license: 10
  - has_tests: 15
  - has_docs: 15
  - has_examples: 10
  - ci_passing: 15
  - no_vulnerabilities: 15
  - maintained: 10  # Updated within 6 months
```

---

## Integration

### CI/CD

```yaml
# GitHub Actions
name: Vais CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: vais/setup-vais@v1
        with:
          version: "1.0"
      - run: vais test
      - run: vais lint

  publish:
    needs: test
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: vais/setup-vais@v1
      - run: vais publish
        env:
          VAIS_TOKEN: ${{ secrets.VAIS_TOKEN }}
```

### IDE Integration

```json
// VSCode settings.json
{
    "vais.packageManager": "vais",
    "vais.formatOnSave": true,
    "vais.lintOnSave": true
}
```

---

## Migration Guide

### From npm

```bash
# Convert package.json → vais.toml
vais migrate npm
```

### From Cargo

```bash
# Convert Cargo.toml → vais.toml
vais migrate cargo
```

### From pip

```bash
# Convert requirements.txt → vais.toml
vais migrate pip
```

---

## Summary

Package system design essentials:

| Component | Description |
|-----------|-------------|
| **vais.toml** | Cargo.toml-style manifest |
| **vais.lock** | Reproducible build guarantee |
| **CLI** | Best of npm + Cargo combined |
| **Registry** | Central + private support |
| **Workspace** | Monorepo support |
| **Security** | Signing, scanning, auditing |

**Easy package system = Thriving ecosystem**
